From ba09d590a6fe4601291ca4ae426ed7af98535b17 Mon Sep 17 00:00:00 2001
From: Dan Williams <dcbw@redhat.com>
Date: Thu, 30 Oct 2014 09:49:38 -0500
Subject: [PATCH 1/5] libnm/libnm-util: add Wi-Fi 'powersave' property

---
 libnm-util/libnm-util.ver        |    1 
 libnm-util/nm-setting-wireless.c |   44 +++++++++++++++++++++++++++++++++++++++
 libnm-util/nm-setting-wireless.h |    2 +
 3 files changed, 47 insertions(+)

Index: b/libnm-util/libnm-util.ver
===================================================================
--- a/libnm-util/libnm-util.ver
+++ b/libnm-util/libnm-util.ver
@@ -558,6 +558,7 @@ global:
 	nm_setting_wireless_get_mtu;
 	nm_setting_wireless_get_num_mac_blacklist_items;
 	nm_setting_wireless_get_num_seen_bssids;
+	nm_setting_wireless_get_powersave;
 	nm_setting_wireless_get_rate;
 	nm_setting_wireless_get_security;
 	nm_setting_wireless_get_seen_bssid;
Index: b/libnm-util/nm-setting-wireless.c
===================================================================
--- a/libnm-util/nm-setting-wireless.c
+++ b/libnm-util/nm-setting-wireless.c
@@ -88,6 +88,7 @@ typedef struct {
 	GSList *seen_bssids;
 	char *security;
 	gboolean hidden;
+	guint32 powersave;
 } NMSettingWirelessPrivate;
 
 enum {
@@ -106,6 +107,7 @@ enum {
 	PROP_SEEN_BSSIDS,
 	PROP_SEC,
 	PROP_HIDDEN,
+	PROP_POWERSAVE,
 
 	LAST_PROP
 };
@@ -665,6 +667,20 @@ nm_setting_wireless_get_hidden (NMSettin
 }
 
 /**
+ * nm_setting_wireless_get_powersave:
+ * @setting: the #NMSettingWireless
+ *
+ * Returns: the #NMSettingWireless:powersave property of the setting
+ **/
+guint32
+nm_setting_wireless_get_powersave (NMSettingWireless *setting)
+{
+	g_return_val_if_fail (NM_IS_SETTING_WIRELESS (setting), 0);
+
+	return NM_SETTING_WIRELESS_GET_PRIVATE (setting)->powersave;
+}
+
+/**
  * nm_setting_wireless_add_seen_bssid:
  * @setting: the #NMSettingWireless
  * @bssid: the new BSSID to add to the list
@@ -863,6 +879,16 @@ verify (NMSetting *setting, GSList *all_
 		}
 	}
 
+	if (priv->powersave > 1) {
+		g_set_error (error,
+		             NM_SETTING_WIRELESS_ERROR,
+		             NM_SETTING_WIRELESS_ERROR_INVALID_PROPERTY,
+		             _("'%u' is not a valid powersave value"),
+		             priv->powersave);
+		g_prefix_error (error, "%s.%s: ", NM_SETTING_WIRELESS_SETTING_NAME, NM_SETTING_WIRELESS_POWERSAVE);
+		return FALSE;
+	}
+
 	return TRUE;
 }
 
@@ -956,6 +982,9 @@ set_property (GObject *object, guint pro
 	case PROP_HIDDEN:
 		priv->hidden = g_value_get_boolean (value);
 		break;
+	case PROP_POWERSAVE:
+		priv->powersave = g_value_get_uint (value);
+		break;
 	default:
 		G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
 		break;
@@ -1011,6 +1040,9 @@ get_property (GObject *object, guint pro
 	case PROP_HIDDEN:
 		g_value_set_boolean (value, nm_setting_wireless_get_hidden (setting));
 		break;
+	case PROP_POWERSAVE:
+		g_value_set_uint (value, nm_setting_wireless_get_powersave (setting));
+		break;
 	default:
 		G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
 		break;
@@ -1304,4 +1336,16 @@ nm_setting_wireless_class_init (NMSettin
 		                       "hidden SSID networks should be used with caution.",
 		                       FALSE,
 		                       G_PARAM_READWRITE));
+
+	/**
+	 * NMSettingWireless:powersave:
+	 *
+	 * If set to 0, Wi-Fi power saving behavior is disabled.  If set to 1,
+	 * Wi-Fi power saving behavior is enabled.  All other values are reserved.
+	 **/
+	g_object_class_install_property
+		(object_class, PROP_POWERSAVE,
+		 g_param_spec_uint (NM_SETTING_WIRELESS_POWERSAVE, "", "",
+		                    0, G_MAXUINT32, 0,
+		                    G_PARAM_READWRITE));
 }
Index: b/libnm-util/nm-setting-wireless.h
===================================================================
--- a/libnm-util/nm-setting-wireless.h
+++ b/libnm-util/nm-setting-wireless.h
@@ -76,6 +76,7 @@ GQuark nm_setting_wireless_error_quark (
 #define NM_SETTING_WIRELESS_MTU         "mtu"
 #define NM_SETTING_WIRELESS_SEEN_BSSIDS "seen-bssids"
 #define NM_SETTING_WIRELESS_HIDDEN      "hidden"
+#define NM_SETTING_WIRELESS_POWERSAVE   "powersave"
 
 /* Deprecated */
 #define NM_SETTING_WIRELESS_SEC         "security"
@@ -153,6 +154,7 @@ void              nm_setting_wireless_cl
 
 guint32           nm_setting_wireless_get_mtu                (NMSettingWireless *setting);
 gboolean          nm_setting_wireless_get_hidden             (NMSettingWireless *setting);
+guint32           nm_setting_wireless_get_powersave          (NMSettingWireless *setting);
 
 gboolean          nm_setting_wireless_add_seen_bssid         (NMSettingWireless *setting,
 															  const char *bssid);
